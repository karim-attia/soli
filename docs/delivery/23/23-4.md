# 23-4 Isolate orchestration hooks

[Back to task list](../tasks.md)

## Description
Refactor stateful logic such as timers, persistence, solvable shuffle selection, and celebration lifecycle into reusable hooks that encapsulate side effects outside the main Klondike screen component.

## Status History
| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-11-12 13:14:00 | Created | N/A | Proposed | Task documented per refactor analysis. | ai_agent |
| 2025-11-12 15:40:00 | Status Change | Proposed | InProgress | Started extracting timer, persistence, solvable, and celebration logic into hooks. | ai_agent |
| 2025-11-12 16:25:00 | Status Change | InProgress | Review | Timer, persistence, solvable, and celebration hooks integrated; TypeScript checks pass. | ai_agent |

## Requirements
- Introduce hooks under `src/features/klondike/hooks` to encapsulate timer management, storage hydration/persistence, solvable shuffle rotation, and celebration lifecycle control.
- Ensure hooks expose clear inputs/outputs without relying on ambient module state.
- Update the Klondike screen to consume these hooks, reducing inline effect noise and improving readability.
- Document each hook’s purpose and key side effects with JSDoc or inline comments.

## Implementation Plan
1. Create hook files (e.g., `useKlondikeTimer`, `useKlondikePersistence`, `useSolvableShuffleSelector`, `useCelebrationController`).
2. Move corresponding logic from `app/(tabs)/index.tsx`, adapting dependencies to hook arguments and return values.
3. Maintain compatibility with existing reducers and controllers (`useFlightController`, `useAnimationToggles`).
4. Replace in-file effects with hook invocations, adding comments in `index.tsx` describing each hook’s responsibility.
5. Add barrel exports (`src/features/klondike/hooks/index.ts`) to streamline imports.

## Implementation Notes
- Added `useKlondikeTimer`, `useKlondikePersistence`, `useSolvableShuffleSelector`, and `useCelebrationController` under `src/features/klondike/hooks`, mirroring the previous inline logic with typed parameters and shared side-effect handling.
- Updated `src/features/klondike/constants.ts` and `src/features/klondike/types.ts` to expose shared card/celebration types and values consumed by both hooks and the screen.
- Simplified `app/(tabs)/index.tsx` to call the new hooks, removing the large timer/persistence/celebration effect blocks and inlining only the orchestration wiring with descriptive comments.
- Re-synchronized new-game flows by plumbing `requestNewGame` through a ref so the celebration controller hook can trigger dialogs without circular dependencies.

## Test Plan
- `yarn tsc --noEmit`

## Verification
- TypeScript compilation succeeds (`yarn tsc --noEmit`).
- Manual sanity check of new-game and celebration flows ensured caller functions still receive `clearCelebrationDialogTimer`, abort handlers, and bindings from the hook outputs.

## Files Modified
- `app/(tabs)/index.tsx`
- `src/features/klondike/hooks/useKlondikeTimer.ts`
- `src/features/klondike/hooks/useKlondikePersistence.ts`
- `src/features/klondike/hooks/useSolvableShuffleSelector.ts`
- `src/features/klondike/hooks/useCelebrationController.ts`
- `src/features/klondike/constants.ts`
- `src/features/klondike/types.ts`
- `docs/delivery/23/23-4.md`

