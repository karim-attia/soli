# [4-1] Fix undo animation origin tracking

[Back to task list](../tasks.md)

## Description
Capture and reuse pre-move layout metrics so that when a player undoes a move, the returning card animates from the original pile coordinates instead of jumping from the middle of the screen.

## Status History
| Timestamp | Event Type | From Status | To Status | Details | User |
| :-- | :-- | :-- | :-- | :-- | :-- |
| 2025-11-01 09:20:00 | Created | N/A | Proposed | Task created to address incorrect undo animation origins. | ai_agent |
| 2025-11-01 09:59:00 | user_approves | Proposed | Agreed | User approved undo animation origin fix scope. | user |
| 2025-11-01 10:05:00 | start_work | Agreed | InProgress | Began implementing undo card flight origin tracking improvements. | ai_agent |

## Requirements
- Persist card flight snapshots before each move and reuse them during undo animations.
- Ensure undo animations respect stacked card offsets for tableau columns.
- Maintain performance parity with current gameplay (no dropped frames).

## Implementation Plan
1. Audit existing card flight registry to confirm when measurements are recorded relative to reducer state updates.
2. Store the previous layout snapshot on move commit so undo can reference it before the UI re-renders.
3. Update the undo handler to trigger the shared animation pipeline with the stored snapshot as the starting point.
4. Add guards so stale snapshots are discarded when the board changes structure (e.g., new game).
5. Verify on device and web that undo flights originate from the expected pile.

## Test Plan
- Manual: Play moves between tableau columns, undo, and confirm cards fly back from the originating column top.
- Manual: Move a card to the foundation, undo, and ensure the card animates from the foundation back to the tableau slot.
- `yarn test --watch=false` (targeted unit tests if present).
- `yarn tsc --noEmit`.

## Verification
- Manual checks per test plan on iOS simulator and web build.
- `yarn tsc --noEmit`.

## Files Modified
- `app/(tabs)/index.tsx`
- `src/solitaire/klondike.ts`

