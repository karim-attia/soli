# 17-9 Undo scrub should preserve move count

[Back to task list](./tasks.md)

## Description
Difficulty: Easy. Ensure scrub-based undo/redo keeps move totals accurate and allows unlimited undo history depth.

## Status History
| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-11-08 09:30:00 | Created | N/A | Proposed | Task file created with misc polish scope for undo/scrub metrics. | ai_agent |
| 2025-11-08 09:30:10 | Status Change | Proposed | Agreed | User requested implementation to adjust undo move counting. | user |
| 2025-11-08 09:30:20 | Status Change | Agreed | InProgress | Began updating undo history and move counting behaviour. | ai_agent |
| 2025-11-08 09:47:00 | Status Change | InProgress | Review | Implementation complete with updated logic and unit coverage. | ai_agent |

## Requirements
- Scrubbing through the undo timeline must not change the move counter.
- Performing a one-step undo must not change the move counter.
- Undo history capacity must no longer be capped; the player can undo indefinitely in a single session.
- Existing behaviours (draw/recycle/move) must still increment move counts and maintain correct history structure.

## Implementation Plan
- Update `docs/delivery/backlog.md` and `docs/delivery/17/prd.md` to reflect the misc polish framing and new acceptance criteria.
- Remove the legacy `MAX_UNDO_HISTORY` cap and its associated trimming logic.
- Adjust `handleUndo` and `scrubToIndex` so they reuse the snapshot move counts instead of incrementing.
- Add unit coverage that exercises undo and scrub flows to confirm move counts remain unchanged and history depth exceeds the previous cap.
- Run the test suite to validate no regressions.

## Test Plan
- Unit test: execute moves, undo them, and assert the move counter remains unchanged.
- Unit test: perform a series of moves, scrub forward and backward, and assert move counts match the counter prior to scrubbing.
- Unit test: perform more than 200 moves (previous cap), undo back to the start, and confirm no history truncation/assertions fail.
- Manual verification (optional): scrub via the slider in-app and observe the move counter remain stable.

## Verification
- [x] `yarn test --watchAll=false klondike.undo`

## Files Modified
- docs/delivery/backlog.md
- docs/delivery/17/prd.md
- docs/delivery/17/tasks.md
- docs/delivery/17/17-9.md
- src/solitaire/klondike.ts
- test/unit/solitaire/klondike.undo.test.ts

