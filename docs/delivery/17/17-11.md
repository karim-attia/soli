# [17-11] Fix drawer navigation lag and iOS header polish

[Back to task list](./tasks.md)

## Description
Fix navigation drawer lag when switching routes on Android and iOS, rename the header title from "Klondike" to "Soli", and reduce the "New Game" button size following iOS best practices.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-12-09 12:00:00 | Created | N/A | Proposed | Task created for drawer lag and iOS polish fixes | ai_agent |
| 2025-12-09 12:05:00 | Status Change | Proposed | InProgress | Research phase began | ai_agent |
| 2025-12-09 12:15:00 | Status Change | InProgress | Review | Initial fixes implemented | ai_agent |
| 2025-12-09 12:30:00 | Status Change | Review | InProgress | User reported lag persists, deeper analysis needed | ai_agent |
| 2025-12-09 12:45:00 | Status Change | InProgress | Review | Comprehensive performance fixes implemented | ai_agent |

## Requirements

1. **Navigation Drawer Lag**: Reduce or eliminate the lag experienced when opening routes via the navigation drawer on both Android and iOS.
2. **Header Title**: Rename the status bar / header title from "Klondike" to "Soli".
3. **iOS Title Alignment**: Document that iOS enforces centered title as platform convention (cannot be changed).
4. **Button Size**: Reduce the "New Game" button size to follow iOS best practice for navigation bar buttons.

## Research Findings

### Navigation Drawer Lag Root Causes (Deep Analysis)

ADB GPU profiling revealed severe frame time outliers (500ms-2600ms) and high input latency (1424 events). Web research and device analysis identified these causes:

1. **Screen Detachment/Reattachment**: `detachInactiveScreens` (default true) causes screens to be unmounted and remounted during navigation, causing significant delay when reattaching heavy screens.

2. **Lazy Loading Penalty**: `lazy: true` (default) means screens aren't loaded until first navigation, causing a one-time delay.

3. **Heavy Screen Re-renders**: Without `freezeOnBlur`, inactive screens continue to re-render during navigation animations.

4. **Dynamic Imports During Navigation**: The Settings screen performs a dynamic import (`import('../modules/expo-refresh-rate/src')`) in useEffect, which blocks the JS thread during navigation.

5. **Unmemoized Components**: Screen components re-render unnecessarily during navigation transitions.

### Comprehensive Solution

1. **`detachInactiveScreens: false`**: Keep screens attached to avoid reattachment lag. Trades memory for smoother transitions.

2. **`lazy: false`**: Pre-load all screens at app startup to avoid first-navigation delays.

3. **`freezeOnBlur: true`**: Prevent background re-renders while keeping screens attached.

4. **`InteractionManager.runAfterInteractions()`**: Defer heavy operations (like dynamic imports) until after navigation animation completes.

5. **`React.memo()`**: Wrap screen components to prevent unnecessary re-renders.

### iOS Header Title Alignment
- iOS enforces centered header titles by platform design convention
- `headerTitleAlign: 'left'` has no effect on iOS (only works on Android)
- Best practice: Accept the centered title on iOS as it's the expected platform behavior
- To force left alignment would require a custom `headerTitle` component (not recommended as it breaks iOS conventions)

### Button Size Best Practice
- Apple's Human Interface Guidelines recommend 44x44pt minimum tappable area
- However, visual size can be compact while maintaining accessibility
- Tamagui's size scale: `$4` is medium, `$3` is more compact
- Using `size="$3"` provides a visually smaller button while maintaining adequate touch target

## Implementation Plan

1. ✅ Add `detachInactiveScreens={false}` to Drawer component
2. ✅ Add `lazy: false` to Drawer screenOptions
3. ✅ Add `freezeOnBlur: true` to Drawer screenOptions
4. ✅ Wrap Settings screen in `React.memo()`
5. ✅ Wrap History screen in `React.memo()`
6. ✅ Defer dynamic import in Settings using `InteractionManager.runAfterInteractions()`
7. ✅ Memoize `ToggleRow` component in Settings
8. ✅ Change `headerTitle: 'Klondike'` to `headerTitle: 'Soli'`
9. ✅ Change drawer label from "Play Klondike" to "Play"
10. ✅ Reduce button size from `$4` to `$3` in HeaderControls

## Verification

### Test Plan
1. **Navigation Lag Test**:
   - Open app on Android and iOS
   - Navigate from game screen to Settings via drawer
   - Navigate to History, then back to Play
   - Expected: Navigation should feel instant without visible lag

2. **Header Title Test**:
   - Launch app on iOS
   - Verify header shows "Soli" (centered, as per iOS convention)
   - Launch app on Android
   - Verify header shows "Soli"

3. **Button Size Test**:
   - Compare "New Game" button size before/after
   - Verify button is visually smaller but still easily tappable
   - Verify touch target remains accessible

### Success Criteria
- No perceptible lag when navigating between drawer routes
- Header displays "Soli" on both platforms
- "New Game" button appears compact but accessible

## Files Modified

- `app/(tabs)/_layout.tsx` - Added `detachInactiveScreens={false}`, `lazy: false`, `freezeOnBlur: true`; renamed drawer label to "Play"
- `app/(tabs)/index.tsx` - Changed headerTitle to "Soli", reduced button size to `$3`
- `app/settings.tsx` - Wrapped in `React.memo()`, deferred dynamic import with `InteractionManager`, memoized `ToggleRow`
- `app/history.tsx` - Wrapped in `React.memo()`

