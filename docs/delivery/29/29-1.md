[Back to task list](./tasks.md)

# [29-1] Retry adjacent tableau card on invalid tap

## Description
Improve tap-to-auto-move reliability in tableau columns by retrying the adjacent card (above first, then below) when the originally tapped card has no valid auto-move.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
| :-- | :-- | :-- | :-- | :-- | :-- |
| 2025-12-14 21:10:00 | Created | N/A | Proposed | Task created to implement adjacent-card fallback for tableau auto-move taps. | ai_agent |
| 2025-12-14 21:11:00 | Status Change | Proposed | Agreed | User requested forgiving tableau tap behavior. | user |
| 2025-12-14 21:12:00 | Status Change | Agreed | InProgress | Started implementation of tableau adjacent-card auto-move fallback. | ai_agent |
| 2025-12-14 21:25:00 | Status Change | InProgress | Review | Implemented tableau adjacent-card fallback for auto-move and added verification coverage. | ai_agent |

## Requirements
- Only apply fallback logic for `Selection` values where `source === 'tableau'`.
- If `findAutoMoveTarget(state, selection)` returns null for the tapped tableau card:
  - Try the adjacent card above (`cardIndex - 1`) in the same column.
  - If still no move, try the adjacent card below (`cardIndex + 1`) in the same column.
- Only consider adjacent candidates that are within bounds and **face-up**.
- If an adjacent candidate has a valid auto-move target, dispatch that move.
- If neither the tapped card nor adjacent candidates can auto-move, keep the existing invalid-move wiggle feedback for the originally tapped card.
- Keep behavior unchanged for stock/waste/foundation taps.

## Implementation Plan
1. Update `attemptAutoMove` in `src/features/klondike/hooks/useKlondikeGame.ts` to implement the adjacent-card fallback for tableau selections.
2. Add a small inline comment referencing PBI 29 / Task 29-1 near the fallback logic.

## Test Plan
- Manual:
  - With a tableau column containing multiple face-up cards, tap a card that produces no auto-move.
  - Confirm the app tries the adjacent card above first, and if that card has an auto-move it executes it.
  - If the above card cannot auto-move but the below card can, confirm the below card auto-move executes.
  - Confirm the fallback does **not** attempt to auto-move face-down tableau cards (e.g., when the adjacent card above is face-down).
  - Confirm stock/waste/foundation taps behave the same as before.
- Automated:
  - Run `yarn jest --ci`.
  - Run `yarn tsc --noEmit`.

## Verification
- Automated: `yarn jest --ci` passes (includes coverage for the adjacent-card fallback logic).
- Note: `yarn tsc --noEmit` currently fails due to pre-existing type errors in `app/feature-graphic.tsx` and `app/settings.tsx` (unrelated to this change).

## Files Modified
- `docs/delivery/29/tasks.md`
- `docs/delivery/29/29-1.md`
- `src/solitaire/klondike.ts`
- `src/features/klondike/hooks/useKlondikeGame.ts`
