# 10-7 Fix multiple active history entries + ensure start preview is shown

[Back to task list](./tasks.md)

## Description
Fix two regressions in the history system:
1) Multiple games can remain in the 'active' state (especially across app restarts).
2) Solved games can show an empty preview because the end-state snapshot overwrote the start preview.

This task makes the active-session linkage robust by persisting the current history entry id alongside the saved game state, and ensures the history preview always represents the game’s starting state.

## Status History
| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-12-14 | Created | N/A | InProgress | Task created and implementation started | AI |
| 2025-12-14 | Status Change | InProgress | Review | Implemented persistence linkage + active normalization + start-preview preservation | AI |

## Requirements
1. At most one history entry may have status `active` at any time.
2. The currently active (in-progress) game must appear in the history list.
3. Completing a game must update the existing history entry (no duplicates).
4. History sheet preview must always show the **start** state of the game (never the end state).
5. The active-session linkage must survive app restarts (Android/iOS).

## Implementation Plan
1. Persist `historyEntryId` in the Klondike saved-game payload.
2. Restore `historyEntryId` into `currentGameEntryIdRef` during game hydration.
3. Add normalization in history state updates to guarantee only one `active` entry.
4. Stop overwriting `entry.preview` on completion; keep start preview.
5. Add fallback start-preview inference only when a completion record must be created without a tracked entry id.

## Verification
- Start a solvable game → exactly one `active` entry appears.
- Restart app mid-game → still exactly one `active` entry; completing the game updates it to `solved`.
- Solved game shows a non-empty tableau preview (start state) in the sheet.

## Files Modified
- src/storage/gamePersistence.ts
- src/features/klondike/hooks/useKlondikePersistence.ts
- src/features/klondike/hooks/useKlondikeGame.ts
- src/state/history.tsx
