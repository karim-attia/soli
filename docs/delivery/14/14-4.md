[Back to task list](./tasks.md)

# [14-4] Harden measurement + flight gating (LayoutMetrics warning, drawer origin)

## Description
Reanimated-driven snapshot measurement occasionally yields undefined/meaningless layout metrics, producing warnings and causing some card flights (notably draw/stock → waste) to originate from incorrect positions (e.g., seemingly “outside” the screen). This task hardens snapshot collection and ensures draw/undo dispatches wait for valid origin snapshots.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
| :-- | :-- | :-- | :-- | :-- | :-- |
| 2025-12-14 11:30:00 | Created | N/A | Proposed | Created task to address LayoutMetrics warnings and incorrect flight origins. | ai_agent |
| 2025-12-14 11:31:00 | Status Change | Proposed | Agreed | User requested implementation to improve animation smoothness and fix flight-origin issues. | user |
| 2025-12-14 11:32:00 | Status Change | Agreed | InProgress | Began implementing measurement validation/retries and flight gating for draw/undo. | ai_agent |
| 2025-12-14 12:10:00 | Status Change | InProgress | Review | Implemented snapshot validation + measure retries; routed draw/undo through flight controller with inferred card IDs for gating. | ai_agent |

## Requirements
- Prevent invalid snapshot values (e.g., `undefined`, `NaN`, non-finite numbers) from entering the flight snapshot registry.
- When Reanimated `measure()` returns invalid/meaningless metrics, retry a small bounded number of frames and then fall back gracefully (no invisible cards, no bogus snapshots).
- Route draw and undo actions through the flight controller and ensure they wait for the relevant card IDs to have valid snapshots (especially the top stock card) before dispatch.
- Keep undo-scrubber constraints intact (PBI 20-6): do not reintroduce heavy layout tracking during scrubbing.
- Keep the change scoped to PBI-14 determinism/smoothness (no deep work on PBI-26 layering unless directly implicated).

## Implementation Plan
1. Add snapshot validation utilities (finite-number checks) and apply them both where snapshots are produced (card measurement) and where they are stored (flight controller registry).
2. Update card measurement logic to:
   - Avoid hiding the card permanently if measurement fails.
   - Retry measurement briefly when layout metrics are not ready.
3. Extend the flight controller dispatch API to accept explicit `cardIds` to wait on (for actions without a `Selection`).
4. Update `handleDraw` and `handleUndo` to use the flight controller with explicit `cardIds` derived from current state.
5. Add minimal dev-time logging for repeated measurement failures (guarded to avoid noisy production logs).

## Test Plan
- Manual:
  - Rapidly tap Draw at game start and during play; confirm drawn cards animate from the stock position (not from off-screen).
  - Perform multiple undo operations in quick succession; confirm flights do not disappear and do not originate from bogus positions.
  - Trigger auto-complete (`yarn demo:auto-solve`) and observe whether the Reanimated LayoutMetrics warning frequency drops.
- Build checks:
  - `yarn tsc --noEmit`

## Verification
- Local lint diagnostics show no issues in modified files.
- Manual verification recommended on-device: rapid Draw taps should animate from stock reliably; Undo should no longer depend on un-gated snapshots.
- Note: `yarn tsc --noEmit` could not be executed in this worktree due to an existing `package.json`/`yarn.lock` workspace-name mismatch (unrelated to this task’s code changes).

## Files Modified
- `docs/delivery/14/tasks.md`
- `docs/delivery/14/14-4.md`
- `src/animation/flightController.ts`
- `src/features/klondike/components/cards/animations.ts`
- `src/features/klondike/hooks/useKlondikeGame.ts`
- `src/features/klondike/hooks/useDemoGameLauncher.ts`
