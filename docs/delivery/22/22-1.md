# 22-1 Per-card stock rendering refactor

[Back to task list](./tasks.md)

## Description
Render the stock stack as discrete card components so that animation choreography can target the true top card without relying on aggregated stack sprites.

## Status History
| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-11-12 10:30:00 | Created | N/A | Proposed | Task documented with scope and requirements. | ai_agent |
| 2025-11-12 10:31:00 | Status Change | Proposed | Agreed | User approved the per-card stock rendering refactor scope. | user |
| 2025-11-12 10:31:30 | Status Change | Agreed | InProgress | Began implementing per-card stock rendering. | ai_agent |
| 2025-11-12 11:05:00 | Status Change | InProgress | Review | Stock stack renders per card and type checks pass. | ai_agent |
| 2025-11-12 11:10:30 | Status Change | Review | Done | User approved per-card stock rendering behaviour. | user |

## Requirements
- Replace any monolithic stock stack renderings with per-card rendering, similar to the foundation refactor.
- Maintain existing layout, z-index ordering, and input affordances (tap-to-draw, long press gestures if any).
- Ensure top card measurement data remains available for the flight controller and other animation consumers.
- Avoid regressions in performance by memoizing or optimizing renders where necessary.

## Implementation Plan
- Inspect the stock rendering component (likely within `app/(tabs)/index.tsx` or a dedicated stock pile module) to identify the current stacked sprite implementation.
- Introduce a loop that renders individual `CardSprite` (or equivalent) components with appropriate keys and offsets.
- Expose the top card reference and measurement hooks so animation controllers can retrieve origin coordinates without recomputation.
- Update any selectors or derived data that assumed a single stack node to work with per-card nodes.
- Verify the updated render path works in conjunction with draw and recycle logic.

## Test Plan
- Trigger repeated draws and undos to ensure the stock renders the correct number of face-down cards without layout jitter.
- Confirm the top stock card remains interactable via the draw control and that flight animations originate from the correct location.
- Run TypeScript compilation to guarantee type safety.

## Verification
- `yarn tsc --noEmit`
- User approval confirming stock stack renders per card (2025-11-12)

## Files Modified
- `app/(tabs)/index.tsx`
- `docs/delivery/backlog.md`
- `docs/delivery/22/prd.md`
- `docs/delivery/22/tasks.md`
- `docs/delivery/22/22-1.md`

