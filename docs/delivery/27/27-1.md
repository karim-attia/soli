# Task 27-1: Research and API Guide

[Back to task list](./tasks.md)

## Description

Document Android refresh rate APIs and the Expo module pattern required to expose native functionality to React Native.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-12-05 10:00:00 | Created | N/A | Proposed | Task file created | ai_agent |
| 2025-12-05 10:05:00 | Status Change | Proposed | Done | Research completed and documented | ai_agent |

## Requirements

1. Document the Android `Surface.setFrameRate()` API available in API 30+
2. Document how to query available display refresh rates
3. Outline the Expo module structure for Android-only functionality
4. Provide code snippets for the native Kotlin implementation

## Implementation Plan

### Android Refresh Rate APIs

**Surface.setFrameRate() (API 30+)**
```kotlin
// Request specific frame rate
surface.setFrameRate(
    frameRate: Float,           // Target fps (0 = no preference)
    compatibility: Int,         // FRAME_RATE_COMPATIBILITY_*
    changeFrameRateStrategy: Int // CHANGE_FRAME_RATE_* (API 31+)
)
```

Compatibility modes:
- `FRAME_RATE_COMPATIBILITY_DEFAULT` (0): System may switch modes
- `FRAME_RATE_COMPATIBILITY_FIXED_SOURCE` (1): Content was rendered at this rate

**Window approach (alternative)**
```kotlin
val window = activity.window
val params = window.attributes
params.preferredDisplayModeId = modeId // ID of a Display.Mode
window.attributes = params
```

**Querying display modes**
```kotlin
val display = activity.windowManager.defaultDisplay
val modes = display.supportedModes // Array<Display.Mode>
modes.forEach { mode ->
    Log.d("Refresh", "Mode ${mode.modeId}: ${mode.refreshRate}Hz")
}
```

### Expo Module Structure

Create module at `modules/expo-refresh-rate/`:
```
modules/expo-refresh-rate/
├── android/
│   ├── build.gradle
│   └── src/main/java/expo/modules/refreshrate/
│       ├── ExpoRefreshRateModule.kt
│       └── ExpoRefreshRatePackage.kt (if needed)
├── src/
│   └── index.ts
├── expo-module.config.json
└── package.json
```

### Key Implementation Notes

1. Must run on UI thread to access window
2. `setFrameRate()` is a hint, not a guarantee
3. Battery saver mode may override the preference
4. Should gracefully handle devices that don't support high refresh rates

## Verification

- [ ] Documentation captures all relevant Android APIs
- [ ] Code snippets compile conceptually
- [ ] Expo module structure is correct for SDK 53

## Files Modified

- `docs/delivery/27/27-1-android-refresh-rate-guide.md` (to be created)

