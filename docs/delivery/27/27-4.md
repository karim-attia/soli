# Task 27-4: Wire Up and Verify Integration

[Back to task list](./tasks.md)

## Description

Connect the Expo native module to the settings state so that changing the refresh rate preference actually affects the display.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-12-05 10:00:00 | Created | N/A | Proposed | Task file created | ai_agent |
| 2025-12-05 10:20:00 | Status Change | Proposed | Review | Integration complete, awaiting device verification | ai_agent |

## Requirements

1. Call native module when refresh rate setting changes
2. Apply setting on app startup from persisted preference
3. Handle cases where high refresh rate isn't supported
4. Verify setting actually changes display behavior

## Implementation Plan

### Settings Provider Integration

```typescript
// In SettingsProvider, add effect to apply refresh rate
useEffect(() => {
  if (!hydrated) return
  if (Platform.OS !== 'android') return
  
  // Import dynamically to avoid iOS bundle issues
  import('../modules/expo-refresh-rate').then(({ setRefreshRateMode }) => {
    setRefreshRateMode(state.refreshRateMode)
  })
}, [hydrated, state.refreshRateMode])
```

### Startup Application

The effect above handles both:
- Initial application after hydration
- Changes when user modifies the setting

### Error Handling

If the native module isn't available (e.g., on web), the dynamic import should be caught:

```typescript
import('../modules/expo-refresh-rate')
  .then(({ setRefreshRateMode }) => setRefreshRateMode(mode))
  .catch(() => { /* silently ignore on unsupported platforms */ })
```

## Test Plan

### Success Criteria
- Changing setting to "High" results in smoother 120Hz animations
- Changing setting to "Auto" returns control to system
- Setting is applied on app startup
- No errors on iOS/web

### Verification Steps
1. Build app on Android device with 120Hz display
2. Set refresh rate to "High"
3. Observe card animations are smoother
4. Set to "Auto", observe system may throttle during battery saver
5. Kill and reopen app, verify setting persists and applies

## Files Modified

- `src/state/settings.tsx` (add effect)
- Integration with native module

