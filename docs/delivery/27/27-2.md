# Task 27-2: Create Expo Refresh Rate Module

[Back to task list](./tasks.md)

## Description

Create an Expo native module that exposes Android's refresh rate control APIs to JavaScript.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-12-05 10:00:00 | Created | N/A | Proposed | Task file created | ai_agent |
| 2025-12-05 10:10:00 | Status Change | Proposed | Done | Native module implemented at modules/expo-refresh-rate/ | ai_agent |

## Requirements

1. Create Expo module structure in `modules/expo-refresh-rate/`
2. Implement Android native code using Kotlin
3. Export TypeScript API for React Native consumption
4. Handle API level checks gracefully (require API 30+)
5. Provide no-op implementations for iOS/web

## Implementation Plan

### Module API

```typescript
// modules/expo-refresh-rate/src/index.ts
export type RefreshRateMode = 'auto' | 'high' | 'standard'

export function setRefreshRateMode(mode: RefreshRateMode): void
export function getMaxRefreshRate(): number | null
export function isHighRefreshRateSupported(): boolean
```

### Android Implementation

```kotlin
// ExpoRefreshRateModule.kt
@ExpoMethod
fun setRefreshRateMode(mode: String, promise: Promise) {
    val activity = appContext.activityProvider?.currentActivity
    if (activity == null || Build.VERSION.SDK_INT < Build.VERSION_CODES.R) {
        promise.resolve(null)
        return
    }
    
    activity.runOnUiThread {
        val window = activity.window
        val targetFps = when (mode) {
            "high" -> 120f
            "standard" -> 60f
            else -> 0f // auto - no preference
        }
        
        window.decorView.holder.surface.setFrameRate(
            targetFps,
            Surface.FRAME_RATE_COMPATIBILITY_FIXED_SOURCE
        )
        promise.resolve(null)
    }
}
```

### File Structure

```
modules/expo-refresh-rate/
├── android/
│   ├── build.gradle
│   └── src/main/java/expo/modules/refreshrate/
│       └── ExpoRefreshRateModule.kt
├── src/
│   ├── ExpoRefreshRate.ts
│   ├── ExpoRefreshRateModule.ts
│   └── index.ts
├── expo-module.config.json
└── package.json
```

## Test Plan

### Success Criteria
- Module builds without errors during `expo prebuild`
- TypeScript types are correctly exported
- Calling `setRefreshRateMode('high')` on Android doesn't crash
- Calling functions on iOS/web returns gracefully without errors

### Verification Steps
1. Run `expo prebuild --platform android --clean`
2. Build and run on Android device with 120Hz support
3. Verify no TypeScript errors in imports
4. Verify iOS build still succeeds (no-op implementation)

## Files Modified

- `modules/expo-refresh-rate/` (new directory)
- `app.json` (add module to plugins if needed)
- `package.json` (workspace reference if needed)

