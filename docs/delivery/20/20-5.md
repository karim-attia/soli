# 20-5 Proportional scrub delta mapping

[Back to task list](./tasks.md)

## Description
Translate horizontal finger travel into left/right timeline progress proportionally to the remaining undo and redo range so the slider moves predictably from the anchored state.

## Status History
| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-11-17 10:21:00 | Created | N/A | Proposed | Task file drafted with scope and plan. | ai_agent |
| 2025-11-17 10:22:30 | Status Change | Proposed | Agreed | User approved proportional mapping update scope. | user |
| 2025-11-17 10:35:30 | Status Change | Agreed | InProgress | Started implementing proportional delta mapping. | ai_agent |
| 2025-11-17 10:46:00 | Status Change | InProgress | Review | Proportional scrub delta mapping implemented; ready for validation. | ai_agent |
| 2025-11-17 11:05:30 | Implementation Update | Review | Review | Rebased proportional scaling on anchor-relative deltas so edges map to full timeline. | ai_agent |
| 2025-11-17 11:32:30 | Implementation Update | Review | Review | Switched to measured track bounds so dragging to slider ends reaches the timeline endpoints exactly. | ai_agent |

## Requirements
- Convert finger deltas into normalized progress relative to the available left and right slider space captured at gesture start.
- Clamp slider indices so progress cannot exceed the earliest history entry or the furthest redo snapshot.
- Retain existing animation frame throttling and dispatch behaviour when scrubbing ends.

## Implementation Plan
- Extend the gesture origin metadata captured during task 20-4 to include usable left/right pixel space and the corresponding index counts.
- In the gesture update handler, derive normalized progress by dividing the finger delta by the stored left/right pixel span, guarding against divide-by-zero when the anchor touches an edge.
- Multiply normalized progress by the remaining index range (history depth on the left, available future on the right), round to the nearest integer, clamp, and update the scrubber state plus scheduled dispatch.
- Ensure gesture end finalizes with the last computed index and resets the origin metadata for the next interaction.
- **Fix Specification (2025-11-17 11:45)**: Anchor the slider to the current timeline index while storing the fingerâ€™s clamped start position and its distance to each track edge, then map subsequent movement linearly across the recorded undo/redo bounds so the thumb must reach the actual slider ends to select the earliest or latest state without any initial jump.

## Test Plan
- Scrub left from a mid-history position and confirm the slider traverses smoothly toward the initial deal without jumping.
- Scrub right when redo history exists and confirm the slider reaches the maximum future index without requiring exaggerated finger travel.
- Move left then right within one gesture to verify proportional mapping in both directions.

## Verification
- `yarn tsc --noEmit`
- Manual: perform the scrubbing scenarios described above.

## Files Modified
- `src/features/klondike/hooks/useUndoScrubber.ts`


