# 21-1 Balance solvable shuffle rotation

[Back to task list](./tasks.md)

## Description
Randomize solvable shuffle selection among the least-played layouts and immediately log newly dealt solvable games to history so that players avoid duplicate back-to-back deals when skipping without moves.

## Status History
| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-11-12 09:46:00 | Created | N/A | Proposed | Task documented with scope and requirements. | ai_agent |
| 2025-11-12 09:46:30 | Status Change | Proposed | Agreed | User approved solvable shuffle fairness task. | user |
| 2025-11-12 09:47:00 | Status Change | Agreed | InProgress | Began implementing solvable shuffle fairness updates. | ai_agent |
| 2025-11-12 10:10:00 | Status Change | InProgress | Review | Implementation complete; TypeScript checks green. | ai_agent |

## Requirements
- Ensure `selectNextSolvableShuffle` still prefers unsolved shuffles, then chooses uniformly among shuffles tied for the lowest play count.
- Guarantee a solvable shuffle receives a history entry as soon as it is dealt, even if the player makes zero moves.
- Maintain existing history limits, preview sanitization, and storage persistence behaviour.
- Update documentation sections (Implementation Plan, Verification, Files Modified) as work progresses.

## Implementation Plan
- Audit `selectNextSolvableShuffle` in `app/(tabs)/index.tsx` to understand current deterministic tie-breaking.
- Introduce logic to compute the minimum play count and collect all shuffles at that count, preserving the unsolved-first pool.
- Use a random selection helper (existing RNG utilities or `Math.random`) to pick among the collected shuffles in a stable, testable manner.
- Adjust solvable game hydration flow so that it records a history entry immediately after dealing (likely within `dealNewGame` or related dispatch path), ensuring duplicates are prevented by `lastRecordedShuffleRef`.
- Update history state to accept zero-move records without requiring `moveCount > 0`.
- Verify persistence and previews for the new entry shape, making adjustments if needed.

## Test Plan
- Toggle solvable-only mode, deal several new games without making moves, and confirm history captures each deal with `moves` recorded as zero.
- Repeatedly start new solvable games after clearing history to confirm different shuffles appear over multiple runs instead of repeating the first ID.
- Solve one of the shuffles and ensure the selection still prioritizes unsolved entries while randomizing ties among the remaining least-played set.
- Run existing TypeScript and lint checks (`yarn lint`, `yarn tsc --noEmit`) to verify no regressions.

## Verification
- `yarn tsc --noEmit`
- Lint script unavailable (`yarn lint`)

## Files Modified
- `app/(tabs)/index.tsx`
- `docs/delivery/backlog.md`
- `docs/delivery/21/prd.md`
- `docs/delivery/21/tasks.md`
- `docs/delivery/21/21-1.md`

