[Back to task list](./tasks.md)

# [28-1] Stop timer when auto-up starts

## Description
Stop the game timer immediately when auto-up (auto-complete) begins, and ensure timer start logic does not restart the timer while auto-up is active.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
| :-- | :-- | :-- | :-- | :-- | :-- |
| 2025-12-14 12:40:00 | Created | N/A | Proposed | Task created to stop timer on auto-up start and prevent restart during auto-up. | ai_agent |
| 2025-12-14 12:41:00 | Status Change | Proposed | Agreed | User requested auto-up improvements and timer stop behavior. | user |
| 2025-12-14 12:42:00 | Status Change | Agreed | InProgress | Started implementing timer-stop-on-auto-up behavior. | ai_agent |
| 2025-12-14 12:50:00 | Status Change | InProgress | Review | Implemented timer stop on auto-up start and blocked timer restarts during auto-up. | ai_agent |
| 2025-12-14 13:25:00 | Status Change | Review | InProgress | Reopened: timer still running on device; adjust stop logic to use reducer state directly (avoid ref ordering). | ai_agent |
| 2025-12-14 13:35:00 | Status Change | InProgress | Review | Implemented direct timer stop on auto-up start using current state.timerState. | ai_agent |
| 2025-12-14 20:04:39 | Status Change | Review | InProgress | Reopened: timer restarts after win because move-count timer-start effect didn’t guard against `hasWon`. | ai_agent |
| 2025-12-14 20:05:28 | Status Change | InProgress | Review | Prevented timer start-on-move after win by guarding the effect when `hasWon` is true. | ai_agent |

## Requirements
- When `state.isAutoCompleting` transitions from false → true and the timer is running, dispatch `TIMER_STOP` immediately.
- Prevent the “move count increased” timer-start effect from starting the timer during auto-up.
- Prevent the “move count increased” timer-start effect from starting the timer once the game is complete (`hasWon` is true), so auto-up doesn’t “toggle” the timer back on at the win moment.
- Keep behavior unchanged for manual play.

## Implementation Plan
1. Update `useKlondikeTimer` to detect `isAutoCompleting` start and stop the timer.
2. Update timer start-on-move logic to skip starting the timer while auto-up is active or the game has already been won.

## Test Plan
- Manual:
  - Start a game, make at least 1 move so the timer runs.
  - Reach a state where auto-up begins; confirm the timer stops immediately and does not restart while auto-up runs.
  - Complete the game (auto-up completes or last move is manual); confirm the timer stays stopped once the win is reached.

## Verification
- Manual: When auto-up begins (`isAutoCompleting` flips true), timer is stopped immediately.
- Code: move-count timer-start logic skips starting while `isAutoCompleting` is true or `hasWon` is true.
- Note: Typecheck could not be run in this worktree due to an existing lockfile/workspace mismatch (unrelated to this change).

## Files Modified
- `docs/delivery/28/tasks.md`
- `docs/delivery/28/28-1.md`
- `src/features/klondike/hooks/useKlondikeTimer.ts`
