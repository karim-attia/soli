# [11-9] Needed ranks heuristic in atomic solver

[Back to task list](../tasks.md)

## Description
Introduce an optional ranking tie-breaker for the atomic solver that favors candidates satisfying “needed ranks” for blocked tableau columns. When enabled (`useNeededRanks`), the solver identifies the frontier card above each face-down stack, computes the color/rank needed to unlock it (or empty column for kings), weights needs by the number of blocked cards, and prefers candidate approaches whose resulting tableau tops meet those needs.

## Status History
| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-11-01 11:28:00 | Created | N/A | Proposed | Task logged to capture optional needed-ranks heuristic. | ai_agent |
| 2025-11-01 11:36:00 | Status Change | Proposed | InProgress | Implemented heuristic scaffolding and CLI flag plumbing. | ai_agent |
| 2025-11-01 11:49:00 | Status Change | InProgress | Review | Heuristic integrated; smoke-tested via CLI with and without the flag. | ai_agent |

## Requirements
- Compute required target cards (or empty columns) for each tableau column that still hides face-down cards.
- Weight each requirement by blocking depth so deeper stacks exert stronger influence.
- Adjust candidate ranking functions (`leastSteps`, `mostCovered`, `blended`) to prefer candidates satisfying weighted needs when the toggle is enabled.
- Expose public option `useNeededRanks` through `solveKlondikeAtomic` and CLI script parity.
- Document heuristic rationale and trade-offs alongside solver iterations.

## Implementation Plan
1. Add helper in `klondike_solver_atomic.js` to derive needed targets from the current atomic snapshot.
2. Thread optional heuristic through ranking functions with cached scoring per candidate.
3. Surface toggle via solver options (`options.useNeededRanks`) and CLI argument parsing.
4. Update solver iteration notes describing experimentation results.

## Test Plan
- CLI regression: `node scripts/solve-klondike.js --trials=5 --strategy=atomic` (baseline).
- Toggle validation: `node scripts/solve-klondike.js --trials=5 --strategy=atomic --useNeededRanks=true`.
- Spot-check command output for expected config echo showing `useNeededRanks: true`.
- Ensure `solver-iterations.md` documents the new heuristic iteration.

## Verification
- Baseline and toggle commands executed (see Test Plan); observed parity in success rates with heuristic-specific logging confirming activation.
- Verified `solver-iterations.md` entry documents Iteration 3 with heuristic impact.

## Files Modified
- `src/solitaire/klondike_solver_atomic.js`
- `scripts/solve-klondike.js`
- `src/solitaire/solver-iterations.md`
